#!/bin/sh

if [ -z "${__uevent_sh_functions-}" ]; then
__uevent_sh_functions=1

. shell-error

ueventd_pid=
debugdir='/.initrd/udev-events'
eventdir='/.initrd/uevent/queues'
handlerdir='/lib/uevent/handlers'

make_event() {
	local d="$eventdir/${1:-udev}"
	[ -d "$d/.tmp" ] ||
		mkdir -p -- "$d/.tmp"
	mktemp "$d/.tmp/.XXXXXXXXX"
}

release_event() {
	local num='' dummy
	[ ! -e /proc/uptime ] || read -r num dummy < /proc/uptime ||:
	mv -f -- "$2" "${2%/.tmp/*}/$1.${num:-0.0}${2##*/}"
}

done_event() {
	local d="${1%/*}"
	[ -d "$d/.done" ] ||
		mkdir -p -- "$d/.done"
	mv -f -- "$1" "$d/.done"
}

have_rootfs()
{
	if [ ! -e "$rootmnt/$INIT" ]; then
		message "Unable to mount root"
		return 1
	fi
}

have_mountpoints()
{
	local eof='' fsdev fsdir dummy
	while [ -z "$eof" ]; do
		read -r fsdev fsdir dummy ||
			eof=1

		[ -n "$fsdev" ] ||
			continue

		if [ -n "${ROOTONLY-}" ]; then
			[ "$fsdir" = "$rootmnt" ] ||
				continue
		fi

		if [ ! -d "$fsdir" ]; then
			message "$fsdir: Does not exist"
			return 1
		fi

		if ! mountpoint -q "$fsdir"; then
			message "$fsdir: Not mounted"
			return 1
		fi
	done < /etc/fstab
}

fi
