#!/bin/sh

if [ -z "${__uevent_sh_functions-}" ]; then
__uevent_sh_functions=1

. shell-error

ueventd_pid=
debugdir='/.initrd/udev-events'
filterdir='/.initrd/uevent-udev'
eventdir='/.initrd/uevent-events'
extendir='/lib/uevent/extenders'
handlerdir='/lib/uevent/handlers'

make_event() {
	mktemp "$filterdir/.tmp/.XXXXXXXXX"
}

publish_event() {
	mv -f -- "$2" "${2%/.tmp/*}/$1"
}

release_event() {
	local num='' dummy
	[ ! -e /proc/uptime ] || read -r num dummy < /proc/uptime ||:
	publish_event "$1.${num:-0.0}${2##*/}" "$2"
}

done_event() {
	mv -f -- "$1" "${1%/*}/done.${1##*/}"
}

have_rootfs()
{
	if [ ! -e "$rootmnt/$INIT" ]; then
		message "Unable to mount root"
		return 1
	fi
}

have_mountpoints()
{
	local eof='' fsdev fsdir dummy
	while [ -z "$eof" ]; do
		read -r fsdev fsdir dummy ||
			eof=1

		[ -n "$fsdev" ] ||
			continue

		if [ -n "${ROOTONLY-}" ]; then
			[ "$fsdir" = "$rootmnt" ] ||
				continue
		fi

		if [ ! -d "$fsdir" ]; then
			message "$fsdir: Does not exist"
			return 1
		fi

		if ! mountpoint -q "$fsdir"; then
			message "$fsdir: Not mounted"
			return 1
		fi
	done < /etc/fstab
}

fi
